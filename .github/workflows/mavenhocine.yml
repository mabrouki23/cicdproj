name: Build Full Stack Application - Windows with MySQL

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install and configure MySQL
      run: |
        Write-Host "=== Installing MySQL ==="
        
        # T√©l√©charger et installer MySQL
        choco install mysql --version=8.0.35 -y --force
        
        Write-Host "=== MySQL installation completed ==="
      shell: pwsh

    - name: Start MySQL Service
      run: |
        Write-Host "=== Starting MySQL Service ==="
        
        # D√©marrer le service MySQL
        Start-Service -Name "MySQL80"
        
        # Attendre que MySQL soit op√©rationnel
        Start-Sleep -Seconds 10
        
        Write-Host "=== MySQL service started ==="
      shell: pwsh

    - name: Configure MySQL Database
      run: |
        Write-Host "=== Configuring MySQL Database ==="
        
        # Cr√©er la base de donn√©es (MySQL sans mot de passe par d√©faut sur Windows)
        & "C:\Program Files\MySQL\MySQL Server 8.0\bin\mysql.exe" -u root -e "CREATE DATABASE IF NOT EXISTS schooldb;"
        & "C:\Program Files\MySQL\MySQL Server 8.0\bin\mysql.exe" -u root -e "SHOW DATABASES;"
        
        Write-Host "=== Database configured ==="
      shell: pwsh

    - name: Setup Node.js for Angular
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'school-manager-multi/frontend/package-lock.json'

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build Angular frontend with Maven
      run: |
        Write-Host "=== Building Angular Frontend ==="
        cd school-manager-multi
        mvn clean compile -pl frontend -DskipTests=true
        Write-Host "=== Frontend build completed ==="
      shell: pwsh

    - name: Build and Test Spring Boot backend with MySQL
      run: |
        Write-Host "=== Building and Testing Spring Boot Backend ==="
        cd school-manager-multi
        
        # Build avec tests - MySQL est maintenant disponible
        mvn clean package -pl backend -am -DskipTests=false
        
        Write-Host "=== Backend build and tests completed ==="
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/schooldb
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: ""
      shell: pwsh

    - name: Verify JAR content
      run: |
        Write-Host "=== Verifying JAR content ==="
        cd school-manager-multi/backend/target
        
        jar tf *.jar | Select-String -Pattern "(index.html|static/|assets/)" | Select-Object -First 10
        
        Write-Host "=== JAR File ==="
        Get-ChildItem *.jar | Format-Table Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB,2)}} -AutoSize
      shell: pwsh

    - name: Upload Full Stack JAR Artifact
      uses: actions/upload-artifact@v4
      with:
        name: school-manager-fullstack-mysql
        path: school-manager-multi/backend/target/*.jar
        retention-days: 30

    - name: Build success summary
      run: |
        Write-Host "üéâ BUILD SUCCESSFUL WITH MYSQL ON WINDOWS!" -ForegroundColor Green
        Write-Host "üì¶ Artifact: school-manager-fullstack-mysql"
        Write-Host "üóÑÔ∏è  Database: MySQL 8.0 installed locally"
        Write-Host "üñ•Ô∏è  Environment: Windows Runner"
        Write-Host "‚úÖ Tests: Executed with real MySQL database"
        Write-Host "‚¨áÔ∏è  Download from Actions tab"
      shell: pwsh
