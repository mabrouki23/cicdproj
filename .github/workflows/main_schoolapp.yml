name: Build Full Stack Application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
    - name: Cleanup previous artifacts
      uses: actions/github-script@v7
      with:
        script: |
          try {
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            for (const artifact of artifacts.data.artifacts) {
              if (artifact.name.startsWith('school-manager-')) {
                console.log(`Deleting artifact: ${artifact.name}`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
              }
            }
            console.log('‚úÖ Previous artifacts cleaned up');
          } catch (error) {
            console.log('Note: Could not delete artifacts:', error.message);
          }

  build:
    runs-on: ubuntu-latest
    needs: cleanup
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
          MYSQL_DATABASE: schooldb
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Clean build directories
      run: |
        echo "=== CLEANING BUILD DIRECTORIES ==="
        cd school-manager-multi
        
        rm -rf frontend/dist
        rm -rf frontend/node_modules
        rm -rf backend/target
        rm -rf backend/src/main/resources/static
        
        echo "‚úÖ Build directories cleaned"
      shell: bash

    - name: Setup Node.js for Angular
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'school-manager-multi/frontend/package-lock.json'

    - name: Build Angular Frontend
      run: |
        echo "=== BUILDING ANGULAR FRONTEND ==="
        cd school-manager-multi/frontend
        
        # V√©rifier la configuration Angular
        echo "üìÑ Configuration Angular:"
        cat angular.json | grep -A 10 '"build"'
        
        npm ci --no-cache
        npm run build
        
        # Analyse d√©taill√©e de la structure de build
        echo "üîç ANALYSE DU BUILD ANGULAR:"
        echo "üìÅ Structure compl√®te du dossier dist:"
        find dist/ -type f | sort
        echo " "
        echo "üìä Contenu d√©taill√©:"
        ls -la dist/
        if [ -d "dist/frontend" ]; then
          echo "üìÇ Dossier dist/frontend trouv√©:"
          ls -la dist/frontend/
        fi
        if [ -d "dist/browser" ]; then
          echo "üìÇ Dossier dist/browser trouv√©:"
          ls -la dist/browser/
        fi
      shell: bash

    - name: Debug Angular Build Structure
      run: |
        echo "=== DEBUG ANGULAR BUILD STRUCTURE ==="
        cd school-manager-multi/frontend
        
        # Rechercher tous les index.html possibles
        echo "üîé Recherche de index.html:"
        find . -name "index.html" | grep dist
        
        # V√©rifier la structure exacte
        echo " "
        echo "üèóÔ∏è Structure arborescente du build:"
        if [ -d "dist" ]; then
          tree dist/ || find dist/ -type d | sed 's|[^/]*/|- |g'
        fi
      shell: bash

    - name: Copy Angular to Spring Boot
      run: |
        echo "=== COPYING ANGULAR TO SPRING BOOT ==="
        cd school-manager-multi
        
        # Pr√©parer le dossier static
        rm -rf backend/src/main/resources/static
        mkdir -p backend/src/main/resources/static
        
        # STRAT√âGIE DE COPIE AM√âLIOR√âE
        echo "üîç Recherche des fichiers Angular..."
        
        # Option 1: Structure standard Angular (nouvelle version)
        if [ -d "frontend/dist/frontend/browser" ] && [ -f "frontend/dist/frontend/browser/index.html" ]; then
          echo "üì• Copie depuis: frontend/dist/frontend/browser/"
          cp -r frontend/dist/frontend/browser/* backend/src/main/resources/static/
        
        # Option 2: Structure Angular classique
        elif [ -d "frontend/dist/browser" ] && [ -f "frontend/dist/browser/index.html" ]; then
          echo "üì• Copie depuis: frontend/dist/browser/"
          cp -r frontend/dist/browser/* backend/src/main/resources/static/
        
        # Option 3: Structure directe
        elif [ -d "frontend/dist/frontend" ] && [ -f "frontend/dist/frontend/index.html" ]; then
          echo "üì• Copie depuis: frontend/dist/frontend/"
          cp -r frontend/dist/frontend/* backend/src/main/resources/static/
        
        # Option 4: Structure racine
        elif [ -d "frontend/dist" ] && [ -f "frontend/dist/index.html" ]; then
          echo "üì• Copie depuis: frontend/dist/"
          cp -r frontend/dist/* backend/src/main/resources/static/
        
        # Option 5: Recherche r√©cursive
        else
          echo "üîç Recherche avanc√©e de index.html..."
          INDEX_PATH=$(find frontend/dist -name "index.html" -type f | head -1)
          if [ -n "$INDEX_PATH" ]; then
            INDEX_DIR=$(dirname "$INDEX_PATH")
            echo "üì• Copie depuis: $INDEX_DIR"
            cp -r "$INDEX_DIR"/* backend/src/main/resources/static/
          else
            echo "‚ùå ERREUR: Aucun index.html trouv√© dans le build Angular!"
            echo "Structure compl√®te:"
            find frontend/dist -type f
            exit 1
          fi
        fi
        
        # V√©rification finale
        echo " "
        echo "‚úÖ Copie termin√©e - V√âRIFICATION:"
        echo "üìÅ Contenu du dossier static:"
        ls -la backend/src/main/resources/static/
        echo " "
        echo "üìÑ Fichiers principaux:"
        ls -la backend/src/main/resources/static/*.html 2>/dev/null || echo "Aucun fichier HTML trouv√©"
        ls -la backend/src/main/resources/static/*.js 2>/dev/null | head -5
        ls -la backend/src/main/resources/static/*.css 2>/dev/null | head -5
      shell: bash

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build Spring Boot Backend
      run: |
        echo "=== BUILDING SPRING BOOT BACKEND ==="
        cd school-manager-multi
        
        # V√©rifier que les fichiers Angular sont pr√©sents
        echo "üîç V√©rification avant build Maven:"
        if [ -f "backend/src/main/resources/static/index.html" ]; then
          echo "üéâ index.html est pr√©sent dans static/"
          echo "Premi√®res lignes de index.html:"
          head -5 backend/src/main/resources/static/index.html
        else
          echo "‚ùå ERREUR: index.html manquant dans static/"
          exit 1
        fi
        
        mvn clean package -pl backend -am -DskipTests=false
        
        echo "‚úÖ Spring Boot build completed"
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/schooldb
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: ""
      shell: bash

    - name: Verify JAR Content
      run: |
        echo "=== VERIFYING JAR CONTENT ==="
        cd school-manager-multi/backend/target
        
        JAR_FILE=$(ls *.jar)
        echo "üì¶ JAR: $JAR_FILE"
        
        echo "üîç Recherche des fichiers Angular dans le JAR:"
        jar tf $JAR_FILE | grep "BOOT-INF/classes/static/" | head -20
        
        echo " "
        echo "‚úÖ V√©rification index.html:"
        if jar tf $JAR_FILE | grep -q "BOOT-INF/classes/static/index.html"; then
          echo "üéâ INDEX.HTML PR√âSENT DANS LE JAR!"
        else
          echo "‚ùå index.html MANQUANT dans le JAR"
          echo "Contenu static complet:"
          jar tf $JAR_FILE | grep "BOOT-INF/classes/static/"
        fi
      shell: bash

    - name: Upload Fresh JAR Artifact
      uses: actions/upload-artifact@v4
      with:
        name: school-manager-fullstack
        path: school-manager-multi/backend/target/*.jar
        retention-days: 1

    - name: Final Verification
      run: |
        echo " "
        echo "üéâ BUILD COMPLETED SUCCESSFULLY! üéâ"
        echo "==================================="
        echo "‚úÖ Anciens artifacts nettoy√©s"
        echo "‚úÖ Build directories nettoy√©s"
        echo "‚úÖ Angular build√© avec succ√®s"
        echo "‚úÖ Fichiers copi√©s correctement"
        echo "‚úÖ Spring Boot avec Angular int√©gr√©"
        echo "‚úÖ JAR v√©rifi√© et pr√™t"
        echo "üì¶ Nouvel artifact: school-manager-fullstack"
        echo " "
      shell: bash

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write #This is required for requesting the JWT
      contents: read #This is required for actions/checkout
  
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: java-app
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_34B6C2D83350438DA2760BE68F54B189 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_6FD114D13DA74936AC0C3218E3F4DE55 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_1818055A1F7B44DA89D83569503E8778 }}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'schoolapp'
          slot-name: 'Production'
          package: '*.jar'

          
