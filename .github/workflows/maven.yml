name: Build Full Stack Application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
          MYSQL_DATABASE: schooldb
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js for Angular
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'school-manager-multi/frontend/package-lock.json'

    - name: Build Angular First
      run: |
        echo "=== √âTAPE 1: Building Angular Frontend ==="
        cd school-manager-multi/frontend
        
        # Clean install des d√©pendances
        npm ci
        
        # Build Angular
        npm run build
        
        # V√©rifier les fichiers g√©n√©r√©s
        echo "Fichiers Angular g√©n√©r√©s:"
        ls -la dist/
        echo "‚úÖ Angular build COMPLETED"
      shell: bash

    - name: Clean and Prepare Backend Static Directory
      run: |
        echo "=== √âTAPE 2: Pr√©paration du dossier static ==="
        cd school-manager-multi/backend
        
        # Supprimer l'ancien contenu static si existe
        rm -rf src/main/resources/static/*
        
        # Cr√©er le dossier s'il n'existe pas
        mkdir -p src/main/resources/static
        
        echo "‚úÖ Dossier static pr√©par√©"
      shell: bash

    - name: Copy Angular Build to Backend
      run: |
        echo "=== √âTAPE 3: Copie des fichiers Angular vers Spring Boot ==="
        
        # Copier TOUS les fichiers Angular compil√©s
        cp -r school-manager-multi/frontend/dist/* school-manager-multi/backend/src/main/resources/static/
        
        # V√©rifier la copie
        echo "Contenu du dossier static apr√®s copie:"
        ls -la school-manager-multi/backend/src/main/resources/static/
        echo "‚úÖ Copie Angular ‚Üí Spring Boot COMPLETED"
      shell: bash

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build Spring Boot Backend
      run: |
        echo "=== √âTAPE 4: Building Spring Boot Backend ==="
        cd school-manager-multi
        
        # Build backend SEULEMENT (frontend d√©j√† int√©gr√©)
        mvn clean package -pl backend -am -DskipTests=false -Dskip.frontend.build=true
        
        echo "‚úÖ Backend build COMPLETED"
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/schooldb
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: ""
      shell: bash

    - name: Verify Final JAR Content
      run: |
        echo "=== V√âRIFICATION: Contenu du JAR final ==="
        cd school-manager-multi/backend/target
        
        # Lister les fichiers Angular dans le JAR
        echo "Fichiers Angular dans le JAR:"
        jar tf *.jar | grep -E "(index.html|static/|assets/|\.js|\.css)" | head -20
        
        # Taille du JAR
        echo "Taille du JAR:"
        ls -lh *.jar
        echo "‚úÖ V√©rification COMPLETED"
      shell: bash

    - name: Upload Full Stack JAR Artifact
      uses: actions/upload-artifact@v4
      with:
        name: school-manager-fullstack
        path: school-manager-multi/backend/target/*.jar
        retention-days: 30

    - name: Build Success Summary
      run: |
        echo " "
        echo "üéâ üéâ üéâ BUILD FULL STACK R√âUSSI ! üéâ üéâ üéâ"
        echo "==========================================="
        echo "üì¶ Artifact: school-manager-fullstack.jar"
        echo "üîÑ Ordre d'ex√©cution:"
        echo "   1. ‚úÖ Angular build (npm run build)"
        echo "   2. ‚úÖ Copie vers /src/main/resources/static/"
        echo "   3. ‚úÖ Spring Boot build (Maven)"
        echo "   4. ‚úÖ JAR unique g√©n√©r√©"
        echo "üåê Application: Spring Boot + Angular int√©gr√©s"
        echo "üóÑÔ∏è  Database: MySQL avec schooldb"
        echo "‚¨áÔ∏è  T√©l√©chargement: Disponible dans Actions"
        echo " "
      shell: bash
