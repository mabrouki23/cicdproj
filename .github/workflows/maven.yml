name: Build Full Stack Application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
          MYSQL_DATABASE: schooldb
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js for Angular
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'school-manager-multi/frontend/package-lock.json'

    - name: Build Angular
      run: |
        echo "=== BUILD ANGULAR ==="
        cd school-manager-multi/frontend
        npm ci
        npm run build
        echo "✅ Angular build completed"
      shell: bash

    - name: Clean Backend Static
      run: |
        echo "=== CLEAN STATIC DIRECTORY ==="
        cd school-manager-multi/backend
        rm -rf src/main/resources/static
        mkdir -p src/main/resources/static
      shell: bash

    - name: Copy Angular to Backend
      run: |
        echo "=== COPY ANGULAR TO SPRING BOOT ==="
        
        # Vérifier la structure Angular
        echo "Angular dist content:"
        ls -la school-manager-multi/frontend/dist/
        
        # Copier récursivement
        cp -r school-manager-multi/frontend/dist/* school-manager-multi/backend/src/main/resources/static/
        
        echo "Backend static content after copy:"
        ls -la school-manager-multi/backend/src/main/resources/static/
      shell: bash

    - name: Add Spring Boot Static Configuration
      run: |
        echo "=== ADDING SPRING BOOT STATIC CONFIG ==="
        cd school-manager-multi/backend
        
        # Créer le fichier de configuration pour servir les statics
        mkdir -p src/main/resources
        
        cat > src/main/resources/application.properties << 'EOF'
        # Server Configuration
        server.port=8080
        
        # Static Resources Configuration
        spring.web.resources.static-locations=classpath:/static/
        spring.mvc.static-path-pattern=/**
        
        # MySQL Configuration
        spring.datasource.url=jdbc:mysql://localhost:3306/schooldb
        spring.datasource.username=root
        spring.datasource.password=
        
        # JPA Configuration
        spring.jpa.hibernate.ddl-auto=update
        spring.jpa.show-sql=true
        spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect
        
        # Frontend Routing (SPA support)
        spring.web.resources.add-mappings=true
        spring.web.resources.cache.period=3600
        EOF
        
        echo "✅ Spring Boot configuration added"
        
        # Vérifier que index.html est présent
        if [ -f "src/main/resources/static/index.html" ]; then
          echo "✅ index.html found in static directory"
        else
          echo "❌ index.html NOT found!"
          find src/main/resources/static/ -name "*.html"
        fi
      shell: bash

    - name: Add Spring Boot Controller for SPA
      run: |
        echo "=== ADDING SPA CONTROLLER ==="
        cd school-manager-multi/backend
        
        # Créer le dossier pour le controller
        mkdir -p src/main/java/com/hocine/controller
        
        # Créer le controller pour rediriger vers index.html
        cat > src/main/java/com/hocine/controller/SpaController.java << 'EOF'
        package com.hocine.controller;
        
        import org.springframework.stereotype.Controller;
        import org.springframework.web.bind.annotation.RequestMapping;
        
        @Controller
        public class SpaController {
            
            @RequestMapping(value = "/{path:[^\\.]*}")
            public String redirect() {
                return "forward:/index.html";
            }
        }
        EOF
        
        echo "✅ SPA Controller added"
      shell: bash

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build Spring Boot Backend
      run: |
        echo "=== BUILDING SPRING BOOT ==="
        cd school-manager-multi
        
        # Compiler d'abord pour vérifier les erreurs
        mvn clean compile -pl backend -am
        
        # Puis package
        mvn package -pl backend -am -DskipTests=false -Dskip.frontend.build=true
        
        echo "✅ Spring Boot build completed"
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/schooldb
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: ""
      shell: bash

    - name: Verify JAR Content
      run: |
        echo "=== VERIFYING JAR CONTENT ==="
        cd school-manager-multi/backend/target
        
        JAR_FILE=$(ls *.jar)
        echo "JAR file: $JAR_FILE"
        
        echo "Static files in JAR:"
        jar tf $JAR_FILE | grep "BOOT-INF/classes/static/" | head -20
        
        echo "Controller in JAR:"
        jar tf $JAR_FILE | grep "SpaController"
        
        echo "Configuration in JAR:"
        jar tf $JAR_FILE | grep "application.properties"
      shell: bash

    - name: Test Application
      run: |
        echo "=== TESTING APPLICATION ==="
        cd school-manager-multi/backend/target
        
        # Démarrer l'application
        java -jar *.jar &
        APP_PID=$!
        
        # Attendre le démarrage
        echo "Waiting for app to start..."
        sleep 30
        
        # Tester les endpoints
        echo "Testing endpoints:"
        curl -v http://localhost:8080/ || echo "Failed to access /"
        curl -v http://localhost:8080/index.html || echo "Failed to access /index.html"
        
        # Arrêter l'application
        kill $APP_PID
        echo "✅ Application test completed"
      shell: bash

    - name: Upload JAR Artifact
      uses: actions/upload-artifact@v4
      with:
        name: school-manager-fullstack
        path: school-manager-multi/backend/target/*.jar
        retention-days: 30
