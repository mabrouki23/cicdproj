name: Build Full Stack Application - Windows with MySQL

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install MySQL Portable from alternative source
      run: |
        Write-Host "=== Installing MySQL Portable from alternative source ==="
        
        # Utiliser une source alternative pour MySQL
        $mysqlUrl = "https://repo.mysql.com/archives/mysql-8.0/mysql-8.0.35-winx64.zip"
        
        # Télécharger MySQL
        Write-Host "Downloading MySQL from: $mysqlUrl"
        Invoke-WebRequest -Uri $mysqlUrl -OutFile "mysql.zip"
        
        # Créer le dossier d'installation
        New-Item -ItemType Directory -Path "C:\mysql" -Force
        
        # Extraire MySQL
        Expand-Archive -Path "mysql.zip" -DestinationPath "C:\mysql-temp" -Force
        Move-Item -Path "C:\mysql-temp\mysql-8.0.35-winx64\*" -Destination "C:\mysql\" -Force
        Remove-Item -Path "C:\mysql-temp" -Recurse -Force
        
        Write-Host "=== MySQL Portable extracted successfully ==="
      shell: pwsh

    - name: Initialize and Start MySQL
      run: |
        Write-Host "=== Initializing MySQL ==="
        
        # Initialiser MySQL (sans mot de passe)
        & "C:\mysql\bin\mysqld.exe" --initialize-insecure --console
        
        # Démarrer MySQL en arrière-plan
        Start-Process -FilePath "C:\mysql\bin\mysqld.exe" -ArgumentList "--console" -NoNewWindow
        
        # Attendre que MySQL soit opérationnel
        Write-Host "Waiting for MySQL to start..."
        Start-Sleep -Seconds 15
        
        Write-Host "=== MySQL started successfully ==="
      shell: pwsh

    - name: Configure Database
      run: |
        Write-Host "=== Configuring Database ==="
        
        # Créer la base de données
        & "C:\mysql\bin\mysql.exe" -h 127.0.0.1 -P 3306 -u root -e "CREATE DATABASE IF NOT EXISTS schooldb;"
        & "C:\mysql\bin\mysql.exe" -h 127.0.0.1 -P 3306 -u root -e "SHOW DATABASES;"
        
        Write-Host "=== Database configured ==="
      shell: pwsh

    - name: Setup Node.js for Angular
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'
        cache: 'npm'
        cache-dependency-path: 'school-manager-multi/frontend/package-lock.json'

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build Angular frontend
      run: |
        Write-Host "=== Building Angular Frontend ==="
        cd school-manager-multi
        mvn clean compile -pl frontend -DskipTests=true
        Write-Host "=== Frontend build completed ==="
      shell: pwsh

    - name: Build and Test Spring Boot backend
      run: |
        Write-Host "=== Building and Testing Spring Boot Backend ==="
        cd school-manager-multi
        
        # Build avec tests MySQL
        mvn clean package -pl backend -am -DskipTests=false
        
        Write-Host "=== Backend build and tests completed ==="
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://127.0.0.1:3306/schooldb
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: ""
      shell: pwsh

    - name: Upload JAR Artifact
      uses: actions/upload-artifact@v4
      with:
        name: school-manager-fullstack
        path: school-manager-multi/backend/target/*.jar
        retention-days: 30
