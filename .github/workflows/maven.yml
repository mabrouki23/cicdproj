name: Build Full Stack Application - Windows with MySQL

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install MySQL with alternative method
      run: |
        Write-Host "=== Installing MySQL with alternative method ==="
        
        # Installer MySQL sans version spécifique
        choco install mysql -y --force
        
        Write-Host "=== MySQL installation completed ==="
      shell: pwsh

    - name: Start MySQL Service
      run: |
        Write-Host "=== Starting MySQL Service ==="
        
        # Démarrer le service MySQL (le nom peut varier)
        $mysqlService = Get-Service | Where-Object {$_.Name -like "*mysql*"}
        if ($mysqlService) {
            Write-Host "Found MySQL service: $($mysqlService.Name)"
            Start-Service -Name $mysqlService.Name
            Start-Sleep -Seconds 15
            Write-Host "MySQL service started successfully"
        } else {
            Write-Host "MySQL service not found, trying common names..."
            # Essayer les noms de service courants
            $serviceNames = @("MySQL80", "MySQL", "MySQL57", "MySQL56")
            foreach ($serviceName in $serviceNames) {
                try {
                    Start-Service -Name $serviceName -ErrorAction SilentlyContinue
                    Write-Host "Started service: $serviceName"
                    Start-Sleep -Seconds 15
                    break
                } catch {
                    Write-Host "Service $serviceName not found"
                }
            }
        }
      shell: pwsh

    - name: Configure MySQL Database
      run: |
        Write-Host "=== Configuring MySQL Database ==="
        
        # Essayer différents chemins possibles pour mysql.exe
        $mysqlPaths = @(
            "C:\Program Files\MySQL\MySQL Server 8.0\bin\mysql.exe",
            "C:\Program Files\MySQL\MySQL Server 8.1\bin\mysql.exe",
            "C:\Program Files\MySQL\MySQL Server 5.7\bin\mysql.exe",
            "C:\tools\mysql\current\bin\mysql.exe"
        )
        
        $mysqlFound = $false
        foreach ($path in $mysqlPaths) {
            if (Test-Path $path) {
                Write-Host "Found MySQL at: $path"
                & $path -u root -e "CREATE DATABASE IF NOT EXISTS schooldb;"
                & $path -u root -e "SHOW DATABASES;"
                $mysqlFound = $true
                break
            }
        }
        
        if (-not $mysqlFound) {
            Write-Host "MySQL client not found in standard locations"
            # Essayer de trouver via le PATH
            $mysqlInPath = Get-Command mysql -ErrorAction SilentlyContinue
            if ($mysqlInPath) {
                Write-Host "Found MySQL in PATH: $($mysqlInPath.Source)"
                mysql -u root -e "CREATE DATABASE IF NOT EXISTS schooldb;"
                mysql -u root -e "SHOW DATABASES;"
            } else {
                Write-Host "WARNING: MySQL client not found, tests may fail"
            }
        }
        
        Write-Host "=== Database configuration attempted ==="
      shell: pwsh

    - name: Setup Node.js for Angular (Latest LTS)
      uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'
        cache: 'npm'
        cache-dependency-path: 'school-manager-multi/frontend/package-lock.json'

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build Angular frontend with Maven
      run: |
        Write-Host "=== Building Angular Frontend ==="
        cd school-manager-multi
        mvn clean compile -pl frontend -DskipTests=true
        Write-Host "=== Frontend build completed ==="
      shell: pwsh

    - name: Build and Test Spring Boot backend
      run: |
        Write-Host "=== Building and Testing Spring Boot Backend ==="
        cd school-manager-multi
        
        # Build avec tests - continuer même si MySQL n'est pas disponible
        mvn clean package -pl backend -am -DskipTests=false
        
        Write-Host "=== Backend build completed ==="
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/schooldb
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: ""
      shell: pwsh

    - name: Upload Full Stack JAR Artifact
      uses: actions/upload-artifact@v4
      with:
        name: school-manager-fullstack-mysql
        path: school-manager-multi/backend/target/*.jar
        retention-days: 30
