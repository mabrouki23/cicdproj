name: Java CI with Maven

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-backend:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: schooldb
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Build and test backend only
      run: |
        cd backend
        mvn clean package -DskipTests=false -Dskip.frontend.build=true
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/schooldb
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: 

    - name: Upload backend JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: backend-jar
        path: backend/target/*.jar
        retention-days: 7

  build-frontend:
    runs-on: ubuntu-latest
    needs: build-backend
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Run tests
      run: |
        cd frontend
        npm run test -- --watch=false --browsers=ChromeHeadless
    
    - name: Build Angular app
      run: |
        cd frontend
        npm run build
    
    - name: Upload frontend build artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: frontend/dist/
        retention-days: 7

  full-build:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: schooldb
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Build complete project
      run: |
        mvn clean install -DskipTests=false -Dskip.frontend.build=false
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/schooldb
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: root
    
    - name: Run integration tests
      run: |
        cd backend
        mvn verify -DskipTests=false
    
    - name: Upload complete build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: complete-build
        path: |
          backend/target/*.jar
          frontend/dist/
        retention-days: 7

  security-scan:
    runs-on: ubuntu-latest
    needs: full-build
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Run OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'school-manager'
        path: '.'
        format: 'HTML'
        args: >
          --failOnCVSS 7
          --scan backend/
          --scan frontend/
          --nodeAuditSkipDevDependencies

    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: reports/
        retention-days: 30

  docker-build:
    runs-on: ubuntu-latest
    needs: full-build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: complete-build
        path: artifacts/
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      run: |
        docker build -t school-manager:latest -f Dockerfile .
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Push Docker image
      run: |
        docker tag school-manager:latest ${{ secrets.DOCKERHUB_USERNAME }}/school-manager:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/school-manager:latest
