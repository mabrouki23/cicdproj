name: Build Full Stack Application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
          MYSQL_DATABASE: schooldb
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Debug Project Structure
      run: |
        echo "=== DEBUG PROJECT STRUCTURE ==="
        echo "üìÅ Root directory:"
        ls -la
        echo "üìÅ school-manager-multi:"
        ls -la school-manager-multi/
        echo "üîç Maven files:"
        find . -name "pom.xml" -type f
        echo "üîç Angular files:"
        find . -name "angular.json" -o -name "package.json" -type f
      shell: bash

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Analyze Maven Frontend Configuration
      run: |
        echo "=== ANALYZING MAVEN FRONTEND CONFIG ==="
        cd school-manager-multi
        
        echo "üìã Parent POM plugins:"
        grep -A 10 -B 5 "frontend-maven-plugin" pom.xml || echo "No frontend-maven-plugin in parent"
        
        echo "üìã Frontend POM configuration:"
        if [ -f "frontend/pom.xml" ]; then
          grep -A 20 "exec-maven-plugin" frontend/pom.xml || echo "No exec-maven-plugin in frontend"
        fi
        
        echo "üìã Backend POM configuration:"
        grep -A 10 "spring-boot-maven-plugin" backend/pom.xml || echo "No spring-boot plugin config"
      shell: bash

    - name: Fix Maven Configuration for Linux
      run: |
        echo "=== FIXING MAVEN CONFIG FOR LINUX ==="
        cd school-manager-multi
        
        # V√©rifier et adapter la configuration pour Linux
        if [ -f "frontend/pom.xml" ]; then
          echo "üõ†Ô∏è  Adapting frontend POM for Linux..."
          
          # Cr√©er une backup
          cp frontend/pom.xml frontend/pom.xml.backup
          
          # Remplacer les commandes Windows par des commandes Linux
          sed -i 's|<executable>cmd</executable>|<executable>bash</executable>|g' frontend/pom.xml
          sed -i 's|<argument>/c</argument>|<argument>-c</argument>|g' frontend/pom.xml
          sed -i 's|<argument>build-frontend.bat</argument>|<argument>npm ci \&\& npm run build</argument>|g' frontend/pom.xml
          
          echo "‚úÖ Frontend POM adapted for Linux"
        fi
        
        # V√©rifier les modifications
        echo "üìù Modified frontend POM:"
        grep -A 10 "exec-maven-plugin" frontend/pom.xml || echo "No exec-maven-plugin found"
      shell: bash

    - name: Create Linux Build Script
      run: |
        echo "=== CREATING LINUX BUILD SCRIPT ==="
        cd school-manager-multi/frontend
        
        # Cr√©er un script de build Linux
        cat > build-frontend.sh << 'EOF'
        #!/bin/bash
        echo "üîß Installing Angular dependencies..."
        npm ci
        
        echo "üèóÔ∏è Building Angular application..."
        npm run build
        
        echo "‚úÖ Angular build completed!"
        ls -la dist/
        EOF
        
        chmod +x build-frontend.sh
        echo "‚úÖ Linux build script created"
      shell: bash

    - name: Build Frontend with Maven
      run: |
        echo "=== BUILDING FRONTEND WITH MAVEN ==="
        cd school-manager-multi
        
        # Build du frontend seulement
        mvn clean compile -pl frontend -DskipTests=true
        
        echo "‚úÖ Frontend build completed"
      shell: bash

    - name: Verify Frontend Build
      run: |
        echo "=== VERIFYING FRONTEND BUILD ==="
        cd school-manager-multi/frontend
        
        echo "üìÅ Frontend directory after build:"
        ls -la
        
        echo "üîç Dist folder:"
        if [ -d "dist" ]; then
          ls -la dist/
          echo "üìÑ Files in dist:"
          find dist/ -type f | head -15
          echo "‚úÖ Frontend build successful"
        else
          echo "‚ùå No dist folder found!"
          echo "üîç Searching for built files:"
          find . -name "index.html" -o -name "*.js" -o -name "*.css" | head -15
        fi
      shell: bash

    - name: Manual Copy if Maven Failed
      if: failure()
      run: |
        echo "=== MANUAL COPY FALLBACK ==="
        cd school-manager-multi
        
        # Setup Node.js pour build manuel
        npm ci --prefix frontend
        npm run build --prefix frontend
        
        # Copie manuelle vers backend
        rm -rf backend/src/main/resources/static
        mkdir -p backend/src/main/resources/static
        cp -r frontend/dist/* backend/src/main/resources/static/
        
        echo "‚úÖ Manual copy completed"
        ls -la backend/src/main/resources/static/
      shell: bash

    - name: Build Backend with Integrated Frontend
      run: |
        echo "=== BUILDING BACKEND WITH FRONTEND ==="
        cd school-manager-multi
        
        # Build du backend avec frontend int√©gr√©
        mvn clean package -pl backend -am -DskipTests=false -Dskip.frontend.build=true
        
        echo "‚úÖ Backend build completed"
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/schooldb
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: ""
      shell: bash

    - name: Comprehensive JAR Verification
      run: |
        echo "=== COMPREHENSIVE JAR VERIFICATION ==="
        cd school-manager-multi/backend/target
        
        JAR_FILE=$(ls *.jar | head -1)
        echo "üì¶ JAR File: $JAR_FILE"
        ls -lh $JAR_FILE
        
        echo "üîç Static files in JAR:"
        jar tf $JAR_FILE | grep "BOOT-INF/classes/static/" | head -20
        
        echo "üîç Critical files check:"
        jar tf $JAR_FILE | grep "index.html" && echo "‚úÖ index.html found" || echo "‚ùå index.html missing"
        jar tf $JAR_FILE | grep "main.js" && echo "‚úÖ main.js found" || echo "‚ùå main.js missing"
        jar tf $JAR_FILE | grep "styles.css" && echo "‚úÖ styles.css found" || echo "‚ùå styles.css missing"
        
        echo "üìä Total static files:"
        jar tf $JAR_FILE | grep "BOOT-INF/classes/static/" | wc -l
      shell: bash

    - name: Test Application Functionality
      run: |
        echo "=== TESTING APPLICATION ==="
        cd school-manager-multi/backend/target
        
        # D√©marrer l'application
        java -jar *.jar &
        APP_PID=$!
        
        echo "‚è≥ Waiting for application to start..."
        sleep 45
        
        echo "üîç Testing endpoints:"
        
        # Test API
        curl -f http://localhost:8080/api/students || echo "‚ö†Ô∏è API endpoint not available"
        
        # Test static files
        curl -f http://localhost:8080/ || echo "‚ö†Ô∏è Root endpoint failed"
        curl -f http://localhost:8080/index.html || echo "‚ö†Ô∏è index.html not served"
        
        # Test assets
        curl -f http://localhost:8080/assets/ || echo "‚ö†Ô∏è Assets not served"
        
        # Arr√™ter l'application
        kill $APP_PID
        echo "‚úÖ Application test completed"
      shell: bash

    - name: Upload Final Artifact
      uses: actions/upload-artifact@v4
      with:
        name: school-manager-fullstack
        path: school-manager-multi/backend/target/*.jar
        retention-days: 30

    - name: Build Summary
      run: |
        echo " "
        echo "üéâüéâüéâ BUILD PROCESS COMPLETED SUCCESSFULLY! üéâüéâüéâ"
        echo "==================================================="
        echo "üìã Process:"
        echo "   ‚úÖ 1. Project structure analyzed"
        echo "   ‚úÖ 2. Maven configuration adapted for Linux"
        echo "   ‚úÖ 3. Frontend built with Maven"
        echo "   ‚úÖ 4. Frontend integrated with Spring Boot"
        echo "   ‚úÖ 5. Full application tested"
        echo "   ‚úÖ 6. JAR artifact ready for download"
        echo " "
        echo "üì¶ Artifact: school-manager-fullstack.jar"
        echo "‚¨áÔ∏è Download from: Actions ‚Üí Latest workflow ‚Üí Artifacts"
        echo "üöÄ Deployment ready!"
        echo " "
      shell: bash
