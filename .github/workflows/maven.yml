name: Build Full Stack Application

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
          MYSQL_DATABASE: schooldb
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Fix Maven Configuration with Proper XML Escaping
      run: |
        echo "=== FIXING MAVEN CONFIG WITH PROPER XML ESCAPING ==="
        cd school-manager-multi
        
        if [ -f "frontend/pom.xml" ]; then
          echo "üõ†Ô∏è Fixing XML escaping in frontend POM..."
          
          # Restaurer la backup d'abord
          cp frontend/pom.xml.backup frontend/pom.xml
          
          # Remplacer avec le bon √©chappement XML
          sed -i 's|<executable>cmd</executable>|<executable>bash</executable>|g' frontend/pom.xml
          sed -i 's|<argument>/c</argument>|<argument>-c</argument>|g' frontend/pom.xml
          sed -i 's|<argument>build-frontend.bat</argument>|<argument>npm ci \&amp;\&amp; npm run build</argument>|g' frontend/pom.xml
          
          echo "‚úÖ XML escaping fixed"
          echo "üìù Fixed POM content:"
          grep -A 10 "exec-maven-plugin" frontend/pom.xml
        else
          echo "‚ùå No frontend/pom.xml found"
        fi
      shell: bash

    - name: Build Complete Project with Fixed Configuration
      run: |
        echo "=== BUILDING COMPLETE PROJECT ==="
        cd school-manager-multi
        
        # Build complet avec la configuration corrig√©e
        mvn clean package -DskipTests=false
        
        echo "‚úÖ Complete build successful"
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/schooldb
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: ""
      shell: bash

    - name: Upload JAR Artifact
      uses: actions/upload-artifact@v4
      with:
        name: school-manager-fullstack
        path: school-manager-multi/backend/target/*.jar
        retention-days: 30
